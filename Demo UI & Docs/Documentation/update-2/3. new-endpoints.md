# New Endpoints Documentation

This document covers all the new endpoints added to the system after the database migration. All endpoints require authentication via JWT token in the Authorization header.

## Authentication Requirements

All endpoints require a valid JWT token in the Authorization header (unless it is public endpoints):
```
Authorization: Bearer <your_jwt_token>
```

## Project Management Endpoints:

### 1. Get Project List

**Endpoint:** `GET/POST /codvid-ai/project/get-project-list`

**Description:** Retrieves a list of all project names for the authenticated user.

**Request:**
```json
{
  "schema_version": "4.0",
  "data": {}
}
```

**Success Response (200):**
```json
{
  "result": true,
  "response": {
    "project_list": ["my_project", "test_project", "demo_project"]
  }
}
```

**Error Response (400/401):**
```json
{
  "result": false,
  "message": "Unauthorized: invalid or expired token"
}
```

**Example Usage:**
```python
response = network.send(
    "codvid-ai/project/get-project-list", 
    session_token=session_token
)
project_list = response.get_dict()["response"]["project_list"]
```

---

### 2. Create Project

**Endpoint:** `POST /codvid-ai/project/create-project`

**Description:** Creates a new project with the specified name.

**Request:**
```json
{
  "schema_version": "4.0",
  "data": {
    "project_name": "my_new_project"
  }
}
```

**Success Response (200):**
```json
{
  "result": true
}
```

**Error Response (400):**
```json
{
  "result": false,
  "message": "Project already exists"
}
```

**Example Usage:**
```python
data = {"project_name": "my_new_project"}
response = network.send(
    "codvid-ai/project/create-project", 
    content=data, 
    session_token=session_token
)
success = response.get_dict().get("result", False)
```

---

### 3. Get Project Data

**Endpoint:** `GET/POST /codvid-ai/project/get-project-data`

**Description:** Retrieves the complete data for a specific project.

**Request:**
```json
{
  "schema_version": "4.0",
  "data": {
    "project_name": "my_project"
  }
}
```

**Success Response (200):**
```json
{
  "result": true,
  "response": {
    "project_data": {
      "schema_version": "1.0",
      "mod_count": 5,
      "date": "18-7-2025",
      "project_info": {
        "description": "My project description",
        "keywords": ["keyword1", "keyword2"]
      },
      "ai_memory": {
        "context": "Previous conversation context"
      },
      "chats": [
        {
          "role": "user",
          "type": "text",
          "text": "Hello, how are you?"
        },
        {
          "role": "assistant",
          "type": "text",
          "text": "I'm doing well, thank you for asking!"
        }
      ]
    }
  }
}
```

**Error Response (400):**
```json
{
  "result": false,
  "message": "Project not exists."
}
```

**Example Usage:**
```python
data = {"project_name": "my_project"}
response = network.send(
    "codvid-ai/project/get-project-data", 
    content=data, 
    session_token=session_token
)
if response.get_dict()["result"]:
    project_data = response.get_dict()["response"]["project_data"]
```

---

### 4. Get Project Mod Count

**Endpoint:** `GET/POST /codvid-ai/project/get-project-mod-count`

**Description:** Retrieves the modification count for a specific project (used for synchronization).

**Request:**
```json
{
  "schema_version": "4.0",
  "data": {
    "project_name": "my_project"
  }
}
```

**Success Response (200):**
```json
{
  "result": true,
  "response": {
    "mod_count": 5
  }
}
```

**Example Usage:**
```python
data = {"project_name": "my_project"}
response = network.send(
    "codvid-ai/project/get-project-mod-count", 
    content=data, 
    session_token=session_token
)
mod_count = response.get_dict()["response"]["mod_count"]
```

---

### 5. Delete Project

**Endpoint:** `POST /codvid-ai/project/delete-project`

**Description:** Permanently deletes a project and all its data.

**Request:**
```json
{
  "schema_version": "4.0",
  "data": {
    "project_name": "project_to_delete"
  }
}
```

**Success Response (200):**
```json
{
  "result": true
}
```

**Error Response (400):**
```json
{
  "result": false,
  "message": "Project not found"
}
```

**Example Usage:**
```python
data = {"project_name": "project_to_delete"}
response = network.send(
    "codvid-ai/project/delete-project", 
    content=data, 
    session_token=session_token
)
success = response.get_dict().get("result", False)
```

---

## User Management Endpoints

### 1. Delete Account

**Endpoint:** `GET/POST /codvid-ai/user/delete-account`

**Description:** Permanently deletes the user's account and all associated data.

**Request:**
```json
{
  "schema_version": "4.0",
  "data": {}
}
```

**Success Response (200):**
```json
{
  "result": true
}
```

**Error Response (400/401):**
```json
{
  "result": false,
  "message": "Account deletion failed"
}
```

**Example Usage:**
```python
response = network.send(
    "codvid-ai/user/delete-account", 
    session_token=session_token
)
success = response.get_dict().get("result", False)
```

---

## Authentication Endpoints

*Note: Authentication endpoints are covered in detail in `login-system.md`*

### Quick Reference:

**Sign Up:** `POST /codvid-ai/auth/signup`
```json
{
  "schema_version": "4.0",
  "data": {
    "auth_type": "email",
    "email": "user@example.com",
    "password": "securepassword123"
  }
}
```

**Login:** `POST /codvid-ai/auth/login`
```json
{
  "schema_version": "4.0",
  "data": {
    "auth_type": "email",
    "email": "user@example.com",
    "password": "securepassword123"
  }
}
```

---

## Common Response Patterns

### Success Response Format
All successful responses follow this pattern:
```json
{
  "result": true,
  "response": {
    // Response data varies by endpoint
  }
}
```

### Error Response Format
All error responses follow this pattern:
```json
{
  "result": false,
  "message": "Descriptive error message"
}
```

### Common Error Messages
- `"Unauthorized: missing session token while accessing non-public routes"` - Missing Authorization header
- `"Unauthorized: invalid or expired token"` - Invalid or expired JWT token
- `"Schema version mismatch. Expected 4.0, got 3.0"` - Wrong schema version
- `"Invalid JSON request body"` - Malformed JSON in request

---

## Complete Workflow Example

Here's a complete example of creating a project, loading it, and starting a chat:

```python
# 1. Login (get session token)
login_data = {
    "auth_type": "email",
    "email": "user@example.com", 
    "password": "password123"
}
login_response = network.send("codvid-ai/auth/login", login_data)
session_token = login_response.get_dict().get("token")

# 2. Create a new project
create_data = {"project_name": "my_new_project"}
create_response = network.send(
    "codvid-ai/project/create-project", 
    content=create_data, 
    session_token=session_token
)

# 3. Load project data into local cache
load_data = {"project_name": "my_new_project"}
load_response = network.send(
    "codvid-ai/project/get-project-data", 
    content=load_data, 
    session_token=session_token
)
project_data = load_response.get_dict()["response"]["project_data"]

# 4. Initialize local cache
local_user_data = {
    "global_data": {"ai_memory": {}, "video_reflections": {}},
    "projects": {"my_new_project": project_data}
}

# 5. Start AI interaction
message = {"role": "user", "type": "text", "text": "Hello!"}
ai_response = network.send_and_stream(
    "codvid-ai/ai/respond",
    content={"project_name": "my_new_project", "message": message},
    session_token=session_token
)
```

---

## Notes

1. **Schema Version**: All requests must use `"schema_version": "4.0"`
2. **Authentication**: All endpoints (except auth endpoints) require valid JWT token
3. **Project Names**: Must be unique per user
4. **Mod Count**: Used for synchronization between client cache and server database
5. **Error Handling**: Always check the `result` field in responses
6. **Data Persistence**: All data is stored in MongoDB and persists across sessions 