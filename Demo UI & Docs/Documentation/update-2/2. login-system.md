# Update 2: Authentication System Integration

This update introduces a robust authentication system to the backend, allowing users to sign up, log in, and make authenticated requests. This documentation outlines the new endpoints, request/response formats, and how to handle authentication on the client-side.

## 1. Authentication Flow Overview

The authentication system uses JSON Web Tokens (JWT) for secure communication. The general flow is as follows:
1.  **Sign Up**: A new user registers with an email and password. The server creates an account and returns a JWT.
2.  **Log In**: An existing user logs in with their credentials. The server verifies the credentials and returns a JWT.
3.  **Authenticated Requests**: For subsequent requests to protected endpoints, the client must include the received JWT in the `Authorization` header.

## 2. New Endpoints

All authentication-related endpoints are prefixed with `/codvid-ai/auth`.

### 2.1. User Registration (Sign Up)

This endpoint allows new users to create an account using their email and a password.

*   **URL**: `{base_url}/codvid-ai/auth/signup`
*   **Method**: `POST`
*   **Request Body**:
    ```json
    {
      "schema_version": "4.0",
      "data": {
        "auth_type": "email",
        "email": "user@example.com",
        "password": "securepassword123"
      }
    }
    ```
    *   `auth_type`: Must be `"email"`.
    *   `email`: The user's email address.
    *   `password`: The user's chosen password.

*   **Success Response (HTTP 201 Created)**:
    ```json
    {
      "result": true,
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
    }
    ```
    *   `token`: A JWT that must be stored securely on the client-side and used for subsequent authenticated requests.

*   **Error Response (HTTP 400 Bad Request or HTTP 500 Internal Server Error)**:
    ```json
    {
      "result": false,
      "message": "Email is already linked to an account"
    }
    ```
    *   `message`: A descriptive error message (e.g., "missing auth_type!", "Email is already linked to an account", "Database error: ...").

### 2.2. User Login

This endpoint allows existing users to log in and obtain a new JWT.

*   **URL**: `{base_url}/codvid-ai/auth/login`
*   **Method**: `POST`
*   **Request Body**:
    ```json
    {
      "schema_version": "4.0",
      "data": {
        "auth_type": "email",
        "email": "user@example.com",
        "password": "securepassword123"
      }
    }
    ```
    *   `auth_type`: Must be `"email"`.
    *   `email`: The user's email address.
    *   `password`: The user's password.

*   **Success Response (HTTP 201 Created)**:
    ```json
    {
      "result": true,
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
    }
    ```
    *   `token`: A JWT that must be stored securely on the client-side and used for subsequent authenticated requests.

*   **Error Response (HTTP 400 Bad Request or HTTP 500 Internal Server Error)**:
    ```json
    {
      "result": false,
      "message": "Email is not linked to an account."
    }
    ```
    *   `message`: A descriptive error message (e.g., "missing auth_type!", "Email is not linked to an account.", "wrong password.", "Database error: ...").

### 2.3. Get User UUID (Optional)

This endpoint allows retrieving a user's UUID by email (for debugging/testing purposes).

*   **URL**: `{base_url}/codvid-ai/auth/get_uuid?email=user@example.com`
*   **Method**: `GET`
*   **Query Parameters**:
    *   `email`: The user's email address.

*   **Success Response (HTTP 200 OK)**:
    ```json
    {
      "uuid": "12345678-1234-1234-1234-123456789012"
    }
    ```

*   **Error Response (HTTP 400 Bad Request or HTTP 404 Not Found)**:
    ```json
    {
      "error": "Email parameter required"
    }
    ```
    or
    ```json
    {
      "error": "User not found"
    }
    ```

## 3. Authenticated Requests

After successful login or signup, the client receives a JWT. This token must be included in the `Authorization` header of all subsequent requests to protected endpoints.

*   **Header Format**: `Authorization: Bearer <your_jwt_token>`

*   **Example (using `fetch` in JavaScript)**:
    ```javascript
    fetch('{base_url}/codvid-ai/ai/respond', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer YOUR_JWT_TOKEN_HERE'
        },
        body: JSON.stringify({
            "schema_version": "4.0",
            "data": { /* ... your request data ... */ }
        })
    })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error('Error:', error));
    ```

### 3.1. Public Paths

The following paths do not require authentication and can be accessed without a JWT:
*   `/codvid-ai/ping`
*   `/codvid-ai/public` (if any are added in the future)
*   `/codvid-ai/auth/login`
*   `/codvid-ai/auth/signup`

All other endpoints under `/codvid-ai` will require a valid JWT.

## 4. JWT (JSON Web Token)

*   **Purpose**: JWTs are used to securely transmit information between parties as a JSON object. The backend uses them to verify the identity of the user making a request.
*   **Expiration**: The JWTs issued by the backend have an expiration time of 30 days. Clients should handle token expiration by prompting the user to log in again if a `401 Unauthorized: invalid or expired token` error is received.
*   **Security**: The token is signed with a secret key, ensuring its integrity. Do not attempt to modify the token on the client-side.

## 5. Error Handling for Authenticated Requests

If any authenticated request fails due to an invalid or missing token, the server will respond with an HTTP 401 Unauthorized status and an error message:

```json
{
  "error": "Unauthorized: missing session token while accessing non-public routes"
}
```
or
```json
{
  "error": "Unauthorized: invalid or expired token"
}
```
Clients should catch these errors and redirect the user to the login page or prompt them to re-authenticate. 

PS: note that http code 401 usually means credentials are invalid or incomplete. It is not the same as code 403, which means forbidden / no permission.