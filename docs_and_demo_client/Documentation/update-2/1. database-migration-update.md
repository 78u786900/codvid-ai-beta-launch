# Update 3: Database Migration and Authentication System

## Overview

This update documents the major architectural changes from the original local chat history system to a modern database-backed system with user authentication. The project has evolved significantly from storing user data locally to using MongoDB with JWT-based authentication.

## Key Changes from Original Documentation

### 1. Data Storage Architecture

**Before (Original Documentation):**

- User data stored locally in `user_data` object within the client
- No persistent storage across sessions
- No user authentication or data isolation

**Current System:**

- User data stored in MongoDB database (`codvid_ai` database)
- Each user has a unique UUID and isolated data storage
- Data persistence across sessions and devices
- User authentication required for all protected operations

### 2. Request Schema Version Updates

**Before:** Schema version "3.0"
**Current:** Schema version "4.0"

The schema version has been incremented to reflect the new authentication and database requirements.

### 3. Authentication System

**Note:** Authentication details are covered in the separate `login-system.md` document. So this document will not talk too much about it.

**Key Change:** Many endpoints now require JWT (Json Web Token) authentication in the Authorization header. This includes AI response endpoint, and more. Only a few endpoints are public. These will be explained in `login-system.md`.

### 4. AI Response Endpoint Changes (`/codvid-ai/ai/respond`)

**Request Format Changes:**

**Before (Original Documentation):**
```json
{
  "schema_version": "3.0",
  "data": {
    "global_data": { "ai_memory": {} },
    "projects": {
      "DEMO_PROJECT_NAME_1": {
        "version": "1.0",
        "ai_memory": {},
        "chats": [ ... ],
        "project_info": { ... }
      }
    }
  }
}
```

**Current:**
```json
{
  "schema_version": "4.0", 
  "data": {
    "project_name": "project_name",
    "message": { "role": "user", "type": "text", "text": "message" }
  }
}
```

**Key Changes:**

- Schema version updated

- Data structure simplified - only project name and message sent

    Coz server retrieves full user context from database

- Client no longer manages data modifications locally

**Whats not changed:**

- The server still reply with the same format, with the `data_mods` field and the client will still modify the local user data cache. But as we had switched the chat data to cloud storage, to ensure client-server coherent, there will be smth like version checking. This will be explained in AI chat updates. The implementation of version control stuff can be done after this update, coz no big refactor needed.

### 6. Data Modification System

**Before:** Client applied all modifications locally
**Current (Hybrid Approach):** 

- **Server**: Applies modifications to database and increments `mod_count`
- **Client**: Receives modification commands and applies them to local cache
- **Synchronization**: `mod_count` field tracks changes for validation
- **Sync Validation**: `check_and_reload_project_data()` compares local vs server `mod_count`
- **Auto-Reload**: If `mod_count` mismatch detected, client reloads project data from server

### 7. User Data Structure Changes

**Before (Local User Data Structure):**

```json
{
  "version": "2.0",
  "global_data": { ... },
  "projects": { ... }
}
```

**Current (Hybrid Architecture):**

**Database's user document Structure:**

```json
{
  "_id": "user_uuid",
  "schema_version": "1.2",
  "profile": {
    "email": "user@example.com"
  },
  "auth_methods": [
    {
      "method": "password",
      "password_hash": "hashed_password"
    }
  ],
  // ðŸ‘‡ This field is the data that the local user data cache stores.
  "data": {
    "global_data": {
      "ai_memory": {},
      "video_reflections": {}
    },
    "projects": {
      "project_name": {
        "schema_version": "1.0",
        "mod_count": 1,
        "date": "18-7-2025",
        "project_info": {
          "description": "",
          "keywords": []
        },
        "ai_memory": {},
        "chats": []
      }
    }
  }
}
```

**Local User Data Cache Structure (Client):**

```json
{
  "global_data": {
    "ai_memory": {},
    "video_reflections": {}
  },
  "projects": {
    "project_name": {
      "schema_version": "1.0",
      "mod_count": 1,
      "date": "18-7-2025",
      "project_info": {
        "description": "",
        "keywords": []
      },
      "ai_memory": {},
      "chats": []
    }
  }
}
```

**Key Changes:**
- **Hybrid Architecture**: Client maintains local cache, server maintains database
- **Synchronization**: `mod_count` field tracks changes for sync validation
- **Database Wrapper**: User data wrapped in database document with UUID, profile, and auth methods
- **Local Cache**: Client keeps local copy of user data for performance
- **Sync Mechanism**: `check_and_reload_project_data()` validates and syncs local cache with server

### 8. Client-Side Changes

**Updated Functions:**
- `ai_interact()` - Now requires authentication token
- `apply_user_data_mods()` - Enhanced with mod_count tracking
- `check_and_reload_project_data()` - New function for sync validation

**Note:** New project management functions and authentication functions are covered in separate documentation files.

### 9. Database Integration

**New Database Collections:**
- `users` - User accounts and data
- `ig_tracking_tasks` - Instagram tracking tasks

**Database Operations:**
- User data CRUD operations
- Project management
- Authentication method storage
- Data modification tracking

## Migration Notes

### For Existing Clients:
1. Update schema version to "4.0"
2. Implement authentication flow (signup/login)
3. Include JWT token in Authorization header for all requests
4. Update request format to only send project name and message
5. Handle new response format with data modifications

### For New Clients:
1. Follow authentication flow documentation
2. Use simplified request format
3. Implement data modification application
4. Handle project management operations

## Backward Compatibility

The new system is **not backward compatible** with the old local storage system. Clients must be updated to use the new authentication and database-backed architecture.

## Testing

Use the updated `client.py` in the demo client folder as a reference implementation for the new system architecture. 